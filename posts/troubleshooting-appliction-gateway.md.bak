---
title: "Troubleshooting Application Gateway"
date: 2023-02-01T10:47:42+01:00
draft: false
---

## Documentos relevantes

* ¿Qué son los listeners? https://learn.microsoft.com/en-us/azure/application-gateway/configuration-listeners
* Comando PowerShell para ver un listener en particular: https://learn.microsoft.com/en-us/powershell/module/az.network/get-azapplicationgatewayhttplistener?view=azps-9.2.0
* Terminación TLS y de extremo a extremo con Application Gateway https://learn.microsoft.com/en-us/azure/application-gateway/ssl-overview
* Página desde donde descargar openssl para windows https://slproweb.com/products/Win32OpenSSL.html
* Certificate Checker: https://tools.keycdn.com/ssl
* SSLABS SSLTEST https://www.ssllabs.com/ssltest/
* Wiki acerca de certificados SSL https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki/333203/How-to-work-with-Certs-for-application-gateway
* OpenSSL commands https://www.redhat.com/sysadmin/6-openssl-commands
* OpenSSL examples https://www.misterpki.com/openssl-s-client/
# Pasos resolución de problemas en APP GW

## Paso 1: Comprobar que el dominio está apuntando a la IP del Application Gateway

Para ello podemos usar el comando dig (https://learn.microsoft.com/en-us/azure/application-gateway/ssl-overview)

```jsdig ritmosereno.com

; <<>> DiG 9.16.1-Ubuntu <<>> ritmosereno.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 29683
;; flags: qr rd ad; QUERY: 1, ANSWER: 7, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available

;; QUESTION SECTION:
;ritmosereno.com.               IN      A

;; ANSWER SECTION:
ritmosereno.com.        0       IN      A       20.73.187.232
ns2-34.azure-dns.net.   0       IN      A       150.171.16.34
ns2-34.azure-dns.net.   0       IN      AAAA    2620:1ec:8ec:10::22
ns3-34.azure-dns.org.   0       IN      A       13.107.222.34
ns3-34.azure-dns.org.   0       IN      AAAA    2a01:111:4000:10::22
ns4-34.azure-dns.info.  0       IN      A       13.107.206.34
ns4-34.azure-dns.info.  0       IN      AAAA    2620:1ec:bda:10::22

;; Query time: 70 msec
;; SERVER: 172.24.128.1#53(172.24.128.1)
;; WHEN: Wed Feb 01 10:49:48 CET 2023
;; MSG SIZE  rcvd: 257
```` 

También podemos usar el comando nslookup

C:\Users\gonzalomu>nslookup www.ritmosereno.com
Server:  UnKnown
Address:  192.168.18.1

Non-authoritative answer:
Name:    www.ritmosereno.com
Address:  20.73.187.232

Tanto con el comando **dig**, como con el comando **nslookup** hemos identificado que la IP es la 20.73.187.232

Ahora comprobamos en el Portal de Azure, o en el ASC en las propiedades

{{< figure src="/Images/APPGWTROUBLESHOOTING/IPFROMPORTAL.jpg" title="IP del servicio APP GW" >}}

Como podemos comprobar el Application Gateway tiene una IP asignada 20.73.187.232, con lo cual una request dirigida a 
http://www.ritmosereno.com, llegará a la IP frontal del APP GW. 


## Paso 2: Comprobar que existe un listener y una regla asociada


Para ver los listeners con PowerShell

```
Connect-AzAccount
$appgw = Get-AzApplicationGateway -Name "APP" -ResourceGroupName "ritmosereno"
echo $appgw.HTTPListenersText
echo $appgw.HTTPSListenersText
````

¿Cómo ver un listener en particular?

https://learn.microsoft.com/en-us/powershell/module/az.network/get-azapplicationgatewayhttplistener?view=azps-9.2.0

```
$Appgw = Get-AzApplicationGateway -Name "ApplicationGateway01" -ResourceGroupName "ResourceGroup01"
$Listener = Get-AzApplicationGatewayHttpListener -Name "Listener01" -ApplicationGateway $Appgw
```

## Paso 3: Si el listener es HTTPs, comprobar la validez del certificado

3.1 ¿Es la fecha del certificado válida?

Por ejemplo, si el dominio es aramcotrading.com

echo | openssl s_client -servername aramcotrading.com -connect aramcotrading.com:443 2>/dev/null | openssl x509 -noout -dates

Nos devolverá

notBefore=Mar  8 00:00:00 2022 GMT
notAfter=Apr  8 23:59:59 2023 GMT

3.2 ¿Es un certificado completo que contiene leaf, intermediate and root CA?


Para ello utilizamos el comando: 

openssl s_client -connect hostname:port -servername hostname

Ejemplo: 
openssl s_client -connect google.com:443 -servername google.com


Si el certificado es válido, veremos algo similar a lo siguiente:

```CONNECTED(00000003)
depth=2 C = US, O = GeoTrust Inc., CN = GeoTrust Global CA
verify return:1
depth=1 C = US, O = Google Trust Services, CN = GTS CA 1O1
verify return:1
depth=0 C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com
verify return:1
---
Certificate chain
 0 s:C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com
   i:C = US, O = Google Trust Services, CN = GTS CA 1O1
   1 s:C = US, O = Google Trust Services, CN = GTS CA 1O1
     i:C = US, O = GeoTrust Inc., CN = GeoTrust Global CA
---
Server certificate
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
subject=C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com
issuer=C = US, O = Google Trust Services, CN = GTS CA 1O1
...
```

Éste es un certificado con la cadena de verificación completa:

deep 2 = Root Certificate

deep 1 = Intermediate Certificate

deep 0 = Leaf certificate

{{< figure src="/Images/APPGWTROUBLESHOOTING/FULLCHAIN.jpg" title="" >}}

Si al comprobar los certificados nos da errores, tales como


verify error:num=20: unable to get local issuer certificate in the above means the intermediate cert is missing from the chain
verify error:num=21: unable to verify the first certificate in the above means the root cert is missing from the chain

Esto significa que el certificado no tiene la cadena completa (falta root, indermediate or leaf) 
El certificado en el listener del Application Gateway, tiene que contener la cadena completa (el certificado root de la CA, el intermediario y el leaf)

También tiene el requisito de que el "Common Name (CN) del certificado coincida con el host header de la request)

Por ejemplo, si el cliente está haciendo una request a https://www.contoso.com, el CN debe ser www.contoso.com

Si queremos comprobar si un fichero .pfx está bien creado, podemos usar el comando

openssl pkcs12 -info -nokeys -in c:\certificado.pfx

El orden debe ser

leaf --> intermediate --> root

En Application Gateway V2, el orden de los certificados es importante.

Otra forma en la que podemos usar openssl es

openssl s_client --connect IP:PORT -servername FQDN -showcerts

Ejemplo:

openssl s_client --connect 52.154.171.168:443 -servername trainv3.ericashton.com -showcerts

Una herramienta para ver el orden de los certificados

{{< figure src="/Images/APPGWTROUBLESHOOTING/herramienta.jpg" title="" >}}


Para obtener la configuración del Application Gateway

Desde ASC --> Properties --> Raw Gateway Manager Config

O bien directamente desde una máquina SAW, lanzar la query


https://portal.microsoftgeneva.com/FE496009?genevatraceguid=16d75552-54d7-4f09-98c6-9ee2415fc643

https://portal.microsoftgeneva.com/?page=actions&acisEndpoint=Public&managementOpen=false&selectedNodeType=3&extension=Brooklyn&group=Application%20Gateways&operationId=getapplicationgateway&operationName=Get%20Application%20Gateway&inputMode=single&params={"subscriptionid":"6c385e2d-4e18-42a6-8573-9ebfc8173bb8","resourcegroupname":"RG-VWAN-PLT-001","applicationgatewayname":"AGW-PLT-WEU-001","smegatewaymanagerregion":"West%20Europe"}&actionEndpoint=Brooklyn%20-%20Prod&genevatraceguid=16d75552-54d7-4f09-98c6-9ee2415fc643
